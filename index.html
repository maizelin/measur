<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>SMART on FHIR 臨床生理監測平台 - 預載數據版</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; margin: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .patient-card { background: #007bff; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .chart-box { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        h2 { border-left: 5px solid #007bff; padding-left: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="patient-card" id="patient-info">載入中...</div>
    
    <div class="chart-box">
        <h2>三個月血壓趨勢圖 (BP Trend)</h2>
        <canvas id="bpChart"></canvas>
    </div>

    <div class="chart-box">
        <h2>三個月血糖趨勢圖 (BG Trend)</h2>
        <canvas id="bgChart"></canvas>
    </div>
</div>

<script>
    // --- 1. 模擬 360 筆數據生成函數 ---
    function generateMockData() {
        const bp = { labels: [], sbp: [], dbp: [] };
        const bg = { labels: [], values: [] };
        let startDate = new Date('2023-10-01');

        for (let i = 0; i < 90; i++) {
            let currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);
            let dateStr = currentDate.toISOString().split('T')[0];

            // 早上量測
            bp.labels.push(`${dateStr} (早)`);
            bp.sbp.push(Math.floor(Math.random() * (125 - 110 + 1)) + 110);
            bp.dbp.push(Math.floor(Math.random() * (82 - 70 + 1)) + 70);
            
            bg.labels.push(`${dateStr} (早)`);
            bg.values.push(Math.floor(Math.random() * (105 - 85 + 1)) + 85);

            // 晚上量測
            bp.labels.push(`${dateStr} (晚)`);
            bp.sbp.push(Math.floor(Math.random() * (140 - 120 + 1)) + 120);
            bp.dbp.push(Math.floor(Math.random() * (90 - 78 + 1)) + 78);
            
            bg.labels.push(`${dateStr} (晚)`);
            bg.values.push(Math.floor(Math.random() * (145 - 110 + 1)) + 110);
        }
        return { bp, bg };
    }

    // --- 2. 啟動 SMART App 並渲染圖表 ---
    FHIR.oauth2.ready().then(client => {
        client.patient.read().then(p => {
            document.getElementById('patient-info').innerHTML = `
                <strong>姓名：</strong> ${p.name[0].family}${p.name[0].given.join('')} | 
                <strong>ID：</strong> ${p.id} | 
                <strong>狀態：</strong> 已成功連接 FHIR Server 並載入歷史數據
            `;
        });

        const mockData = generateMockData();
        renderCharts(mockData);
    }).catch(() => {
        // 若非從 FHIR 啟動，仍顯示圖表供預覽
        document.getElementById('patient-info').innerHTML = "<strong>預覽模式：</strong> 未連接 FHIR Server，顯示模擬量測數據。";
        renderCharts(generateMockData());
    });

    function renderCharts(data) {
        // 血壓圖
        new Chart(document.getElementById('bpChart'), {
            type: 'line',
            data: {
                labels: data.bp.labels,
                datasets: [
                    { label: '收縮壓 (SBP)', data: data.bp.sbp, borderColor: '#e74c3c', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 1 },
                    { label: '舒張壓 (DBP)', data: data.bp.dbp, borderColor: '#3498db', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 1 }
                ]
            },
            options: { responsive: true, scales: { y: { min: 60, max: 160 } } }
        });

        // 血糖圖
        new Chart(document.getElementById('bgChart'), {
            type: 'bar',
            data: {
                labels: data.bg.labels,
                datasets: [{
                    label: '血糖值 (mg/dL)',
                    data: data.bg.values,
                    backgroundColor: data.bg.values.map(v => v > 130 ? '#f39c12' : '#2ecc71')
                }]
            }
        });
    }
</script>

</body>
</html>